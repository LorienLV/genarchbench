#!/bin/bash

command="$@"

module load vtune_amplifier/2019.4

work_dir=.

amplxe-cl -collect-with runsa \
    -knob enable-user-tasks=true \
    -knob event-config=ARITH.DIVIDER_ACTIVE:sa=2000003,BACLEARS.ANY:sa=100003,BR_MISP_RETIRED.ALL_BRANCHES_PS:sa=400009,BR_MISP_RETIRED.ALL_BRANCHES_PS:sa=400009,CPU_CLK_UNHALTED.ONE_THREAD_ACTIVE:sa=100003,CPU_CLK_UNHALTED.REF_TSC:sa=2500000,CPU_CLK_UNHALTED.REF_XCLK:sa=100003,CPU_CLK_UNHALTED.THREAD:sa=2500000,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CPU_CLK_UNHALTED.THREAD_P:sa=2000003,CYCLE_ACTIVITY.STALLS_L1D_MISS:sa=2000003,CYCLE_ACTIVITY.STALLS_L2_MISS:sa=2000003,CYCLE_ACTIVITY.STALLS_L3_MISS:sa=2000003,CYCLE_ACTIVITY.STALLS_MEM_ANY:sa=2000003,CYCLE_ACTIVITY.STALLS_MEM_ANY:sa=2000003,CYCLE_ACTIVITY.STALLS_MEM_ANY:sa=2000003,DSB2MITE_SWITCHES.PENALTY_CYCLES:sa=2000003,DTLB_LOAD_MISSES.STLB_HIT:sa=2000003,DTLB_LOAD_MISSES.WALK_ACTIVE:sa=100003,DTLB_STORE_MISSES.STLB_HIT:sa=100003,DTLB_STORE_MISSES.WALK_ACTIVE:sa=100003,EXE_ACTIVITY.1_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.1_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.1_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.2_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.2_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.2_PORTS_UTIL:sa=2000003,EXE_ACTIVITY.BOUND_ON_STORES:sa=2000003,EXE_ACTIVITY.BOUND_ON_STORES:sa=2000003,EXE_ACTIVITY.BOUND_ON_STORES:sa=2000003,EXE_ACTIVITY.EXE_BOUND_0_PORTS:sa=2000003,EXE_ACTIVITY.EXE_BOUND_0_PORTS:sa=2000003,EXE_ACTIVITY.EXE_BOUND_0_PORTS:sa=2000003,FP_ARITH_INST_RETIRED.128B_PACKED_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.128B_PACKED_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.128B_PACKED_SINGLE:sa=2000003,FP_ARITH_INST_RETIRED.128B_PACKED_SINGLE:sa=2000003,FP_ARITH_INST_RETIRED.256B_PACKED_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.256B_PACKED_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.256B_PACKED_SINGLE:sa=2000003,FP_ARITH_INST_RETIRED.256B_PACKED_SINGLE:sa=2000003,FP_ARITH_INST_RETIRED.SCALAR_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.SCALAR_DOUBLE:sa=2000003,FP_ARITH_INST_RETIRED.SCALAR_SINGLE:sa=2000003,FP_ARITH_INST_RETIRED.SCALAR_SINGLE:sa=2000003,FP_ASSIST.ANY:sa=100003,ICACHE_16B.IFDATA_STALL:sa=2000003,ICACHE_16B.IFDATA_STALL:sa=2000003,ICACHE_64B.IFTAG_STALL:sa=200003,IDQ.ALL_DSB_CYCLES_4_UOPS:sa=2000003,IDQ.ALL_DSB_CYCLES_ANY_UOPS:sa=2000003,IDQ.ALL_MITE_CYCLES_4_UOPS:sa=2000003,IDQ.ALL_MITE_CYCLES_ANY_UOPS:sa=2000003,IDQ.DSB_UOPS:sa=2000003,IDQ.MITE_UOPS:sa=2000003,IDQ.MS_SWITCHES:sa=2000003,IDQ.MS_UOPS:sa=2000003,IDQ.MS_UOPS:sa=2000003,IDQ.MS_UOPS:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CORE:sa=2000003,IDQ_UOPS_NOT_DELIVERED.CYCLES_0_UOPS_DELIV.CORE:sa=2000003,ILD_STALL.LCP:sa=2000003,INST_RETIRED.ANY:sa=2500000,INST_RETIRED.PREC_DIST:sa=2000003,INST_RETIRED.PREC_DIST:sa=2000003,INT_MISC.CLEAR_RESTEER_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,INT_MISC.RECOVERY_CYCLES:sa=2000003,L1D_PEND_MISS.FB_FULL:sa=2000003,L1D_PEND_MISS.PENDING:sa=2000003,L2_RQSTS.RFO_HIT:sa=200003,LD_BLOCKS.NO_SR:sa=100003,LD_BLOCKS.STORE_FORWARD:sa=100003,LD_BLOCKS_PARTIAL.ADDRESS_ALIAS:sa=100003,LSD.CYCLES_4_UOPS:sa=2000003,LSD.CYCLES_ACTIVE:sa=2000003,LSD.UOPS:sa=2000003,MACHINE_CLEARS.COUNT:sa=100003,MACHINE_CLEARS.COUNT:sa=100003,MEM_INST_RETIRED.ALL_STORES_PS:sa=2000003,MEM_INST_RETIRED.LOCK_LOADS_PS:sa=100007,MEM_INST_RETIRED.SPLIT_LOADS_PS:sa=100003,MEM_INST_RETIRED.SPLIT_STORES_PS:sa=100003,MEM_INST_RETIRED.STLB_MISS_LOADS_PS:sa=100003,MEM_INST_RETIRED.STLB_MISS_STORES_PS:sa=100003,MEM_LOAD_L3_HIT_RETIRED.XSNP_HITM_PS:sa=20011,MEM_LOAD_L3_HIT_RETIRED.XSNP_HIT_PS:sa=20011,MEM_LOAD_L3_HIT_RETIRED.XSNP_MISS_PS:sa=20011,MEM_LOAD_RETIRED.FB_HIT_PS:sa=100003,MEM_LOAD_RETIRED.L1_HIT_PS:sa=2000003,MEM_LOAD_RETIRED.L1_MISS_PS:sa=100003,MEM_LOAD_RETIRED.L2_HIT_PS:sa=100003,MEM_LOAD_RETIRED.L3_HIT_PS:sa=50021,MEM_LOAD_RETIRED.L3_MISS_PS:sa=100007,OFFCORE_REQUESTS_BUFFER.SQ_FULL:sa=2000003,OFFCORE_REQUESTS_OUTSTANDING.ALL_DATA_RD:sa=2000003,OFFCORE_REQUESTS_OUTSTANDING.CYCLES_WITH_DATA_RD:sa=2000003,OFFCORE_REQUESTS_OUTSTANDING.CYCLES_WITH_DEMAND_RFO:sa=2000003,OFFCORE_RESPONSE:request=DEMAND_RFO:response=L3_HIT.SNOOP_HITM:sa=100003,OTHER_ASSISTS.ANY:sa=100003,PARTIAL_RAT_STALLS.SCOREBOARD:sa=2000003,ROB_MISC_EVENTS.PAUSE_INST:sa=2000003,UOPS_DISPATCHED_PORT.PORT_0:sa=2000003,UOPS_DISPATCHED_PORT.PORT_1:sa=2000003,UOPS_DISPATCHED_PORT.PORT_2:sa=2000003,UOPS_DISPATCHED_PORT.PORT_3:sa=2000003,UOPS_DISPATCHED_PORT.PORT_4:sa=2000003,UOPS_DISPATCHED_PORT.PORT_5:sa=2000003,UOPS_DISPATCHED_PORT.PORT_6:sa=2000003,UOPS_DISPATCHED_PORT.PORT_7:sa=2000003,UOPS_EXECUTED.CORE_CYCLES_GE_1:sa=2000003,UOPS_EXECUTED.CORE_CYCLES_GE_2:sa=2000003,UOPS_EXECUTED.CORE_CYCLES_GE_3:sa=2000003,UOPS_EXECUTED.CORE_CYCLES_NONE:sa=2000003,UOPS_EXECUTED.THREAD:sa=2000003,UOPS_EXECUTED.THREAD:sa=2000003,UOPS_EXECUTED.X87:sa=2000003,UOPS_EXECUTED.X87:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_ISSUED.ANY:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003,UOPS_RETIRED.RETIRE_SLOTS:sa=2000003 \
    -knob preciseMultiplexing=true \
    -app-working-dir=${work_dir} -- $command
